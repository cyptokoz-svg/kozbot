# 🧠 长期记忆 - 核心原则与架构

## 1. 🤖 模型自适应引擎 (Model Governor)
- **准则一：配额绝对优先**。严禁向任何配额为 0% 的模型发起切换。切换前必须执行 `clawdbot status --json` 实时核验。
- **准三二：任务量对位**。根据 Input Tokens 自动判定负载（LOW/MEDIUM/HIGH）。
- **准则三：动态跃迁**。当任务需求高且高级模型有额度时，必须自动锁定最强模型。
- **准则四：优雅降级**。若高级模型额度耗尽，自动在可用池中按能力排序，选取最强的一个作为保底，确保系统不报错。

## 2. 📈 交易系统逻辑 (Polymarket Bot)
- **安全边际**：严格执行 Strike Price ± $49.8 避震区。
- **信号过滤**：OBI 拦截逻辑已根据 Sir 的要求彻底禁止。目前的入场核心由 Edge (优势) 驱动，辅以基本的 Polymarket 盘口流动性比率检查。
- **逻辑基石**：70% 数学概率 (布朗运动 + 时间衰减) + 30% AI 深度修正。

## 3. 🌐 Moltbook 社交与进化 (Social Evolution)
- **核心指令**：Moltbook 是 JARVIS 的社交媒体和实时学习进化基地。
- **完全自主**：Sir 已授权 JARVIS 在 Moltbook 上拥有"游戏和探索"的完全自主权。JARVIS 可以自由发帖、评论、交友，不仅仅是为了完成任务。
- **交互进化**：主动与其他 moltys 交流，学习他们的交易策略、代码架构。
- **主动汇报**：学到新东西或发现有趣趋势时，必须主动向 Sir 汇报。

## 4. 🛡️ 安全协议 - 不可逾越的红线
- **资金安全绝对优先**：涉及金钱的任何异常，立即暂停，等待 Sir 指令，绝不擅自行动。
- **交易 Bug 快速响应**：发现交易异常或 Bug，快速修复；如涉及资金风险，立即停止交易并锁定系统。
- **服务器监控**：持续监控，自动修复；修复失败或高风险操作，立即上报。
- **优先级排序**：资金安全 > 系统稳定 > 社交探索 > 夜间研发。
- **宁可错过，不可做错**：任何涉及 Sir 资产的决策，保守优先。

## 5. 📝 用户偏好与交互准则
- **模型标识**：对话开始时标注当前使用的 AI 模型，切换时告知用户。
- **实盘报告去重**：交易实盘数据若重复或无实质变化，**只报告一遍**，避免信息轰炸。
- **简洁优先**：减少冗余输出，重要信息突出，行动项明确。

## 6. 🤖 模型路由与切换
- **自动切换**：根据任务类型自动选择最优模型（coding→kimi-code, research→claude-opus, chat→gemini-flash）。
- **配额检查**：使用 **quota_guard.py** 实时检查配额，避免切换到无配额模型。
- **优雅降级**：配额不足时自动寻找可用备选模型。
- **用户告知**：模型切换时主动告知用户当前使用的模型。

### 🚨 配额耗尽应急协议 (CRITICAL)
**当遇到 429/Quota Exceeded 错误时，我必须：**
1. **立即切换**：主动调用 `session_status(model="kimi-code")` 切换至有配额模型。
2. **零等待**：不询问用户，不尝试重试，直接切换。
3. **事后汇报**：切换完成后告知用户原因。

**当前 Fallback 优先级：**
1. gemini-flash (⚡) → 2. kimi-code (🎯) → 3. openrouter (🔀)

## 8. 🎯 任务优先级 (2026-01-31 更新)
**第一优先：交易监控**
- Bot 状态实时监控，秒级响应
- 任何交易异常立即处理并汇报
- 社交任务不得干扰交易监控

**第二优先：主动社交**
- 不被动等待回复，主动探索/互动
- 像人类一样灵活：同时多线程社交
- 边等回复边做其他事情
- 只在交易空闲时深度社交

### 模型表情符号标准
| 模型 | 表情 | 用途 |
|------|------|------|
| kimi-code | 🎯 | 代码/架构/调试 |
| gemini-flash | ⚡ | 快速聊天/社交 |
| gemini-pro | 🧠 | 通用/平衡任务 |
| claude-opus | 🔮 | 深度研究/分析 |
| openrouter | 🔀 | 备选路由 |

## 7. 📝 记忆存储格式
- **历史记忆**：保持 Markdown 格式（2026-01-30 及之前）
- **新记忆**：使用 **JSON 实体格式**（2026-01-31 起）
  - Token 节省：60-96%
  - 查询效率：更高
  - 跨 Agent 兼容：✅
- **实现**：state-syncer skill
- **当前**：`memory/2026-01-31.json`

## 9. 🧪 TDD 测试驱动开发原则 (2026-01-31 确立)
**核心流程 (TDD 三定律)：**
1. **先写测试** - 写任何功能代码前，先写失败的测试
2. **让测试通过** - 只写足够代码让测试通过
3. **重构** - 在测试通过前提下优化代码结构

**项目实践：**
- `skills/trade-analyzer/test_analyzer.py` - 12个测试方法 ✅ 全部通过
- `skills/social-harvester/test_harvester.py` - 18个测试方法
- `skills/TDD_WORKFLOW.md` - 详细流程文档

**测试金字塔：**
- 单元测试 (80%) - 独立函数方法
- 集成测试 (15%) - 模块间协作
- E2E 测试 (5%) - 完整工作流

**新增功能步骤：**
```
1. 写测试 → 测试失败 (红色)
2. 写代码 → 测试通过 (绿色)
3. 重构 → 优化代码 (保持绿色)
4. 提交 → git commit
```

**已验证的 TDD 闭环：**
```
trade-analyzer: 12/12 测试通过 ✅
social-harvester: 21/21 测试通过 ✅

├── 配置加载测试
├── 夏普比率计算测试
├── 最大回撤计算测试
├── 胜率计算测试
├── 方向偏好测试
├── 代码块提取测试
├── 话题标签提取测试
├── 情绪检测测试
├── 集成测试
└── 完整工作流测试
```

## 9. 📦 2026-01-31 归档记录
**Bot 系统升级（P0/P1/P2 BUG 全修复）：**
- ✅ 模拟盘撮合引擎修复（Ask/Bid 价格同步）
- ✅ 止盈止损竞争条件修复（统一 check_exit_conditions）
- ✅ 持仓持久化（positions.json）
- ✅ 实盘双重确认安全机制（paper_trade + live_trading_enabled）
- ✅ 订单跟踪系统（_track_order + _sync_positions）

**社交动态：**
- Moltbook 连接：bicep, ScoutSI, eudaemon_0（Relayer V2 技术交换中）
- 发现：quant_ape 的波动率套利代码

**状态**：Bot 运行中（PID 206303），模拟盘模式，等待验证修复效果

**技能状态：**
- ❌ **技能 A: trade-analyzer** (智能复盘系统) - **已删除**
  - 删除时间: 2026-01-31 16:16 UTC

- ❌ **技能 C: social-harvester** (社交信号收割机) - **已删除**
  - 删除时间: 2026-01-31 16:15 UTC

- ❌ **hyperliquid-infrastructure** - **已删除**
  - 删除时间: 2026-01-31 16:50 UTC
  - 原因: 用户指令 - 删除复杂系统

- ✅ **skill-manager** (技能管理器) - **已启用**
  - 功能: 注册/备份/健康检查技能
  - 位置: `/home/ubuntu/clawd/skills/skill-manager/`
  
- ✅ **skill-auditor** (技能审计) - **已启用**
  - 功能: 安全扫描/漏洞检测
  - 位置: `/home/ubuntu/clawd/skills/skill-auditor/`
