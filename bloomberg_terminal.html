<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLAWD QUANT // TERMINAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #000000;
            color: #ff9900;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
        }
        .bb-box {
            border: 1px solid #333;
            background: #050505;
            position: relative;
        }
        .bb-header {
            background: #ff9900;
            color: black;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            display: inline-block;
        }
        .grid-layout {
            display: flex;
            flex-direction: column;
            gap: 4px;
            height: 100vh;
            padding: 4px;
        }
        @media (min-width: 1024px) {
            .grid-layout {
                display: grid;
                grid-template-columns: 280px 1fr 320px;
                grid-template-rows: 60px 1fr 300px;
            }
            .col-span-3 { grid-column: span 3; }
        }
        
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        
        .val-up { color: #00ff00 !important; }
        .val-down { color: #ff3333 !important; }
    </style>
</head>
<body>

    <div class="grid-layout">
        <!-- 1. Header -->
        <div class="bb-box col-span-3 flex items-center px-4 justify-between h-14">
            <div class="text-xl tracking-widest font-bold">
                <span class="text-white">CLAWD</span><span class="text-[#ff9900]">BOT</span> <span class="text-xs align-top">量化终端 V3.1</span>
            </div>
            <div class="hidden md:flex gap-8 text-sm">
                <div>状态 <span class="text-green-500">运行中</span></div>
            </div>
            <div class="text-right text-xs text-gray-500">
                系统在线 <span class="blink">●</span><br>
                <span id="last-update">等待数据...</span>
            </div>
        </div>

        <!-- 2. Sidebar -->
        <div class="bb-box flex flex-col p-4 gap-6">
            <div>
                <div class="bb-header">净利润 (24H)</div>
                <div class="text-4xl mt-2 val-up" id="net-pnl">---</div>
                <div class="text-xs text-gray-500 mt-1">目标: 5.00 R</div>
            </div>
            
            <div>
                <div class="bb-header">核心指标</div>
                <div class="grid grid-cols-2 gap-4 mt-2 text-sm">
                    <div class="text-gray-400">胜率</div>
                    <div class="text-right" id="win-rate">--%</div>
                    <div class="text-gray-400">盈亏比</div>
                    <div class="text-right val-up" id="pf">--</div>
                    <div class="text-gray-400">总交易</div>
                    <div class="text-right" id="total-trades">--</div>
                </div>
            </div>
        </div>

        <!-- 3. Chart -->
        <div class="bb-box p-2 relative h-64 lg:h-auto">
            <div class="absolute top-2 left-2 z-10">
                <div class="bb-header">资金曲线</div>
            </div>
            <canvas id="mainChart"></canvas>
        </div>

        <!-- 4. Right: Active -->
        <div class="bb-box p-4">
            <div class="bb-header">最新信号</div>
            <div class="mt-4 border border-green-900 bg-green-900/10 p-3 text-center">
                <div class="text-xs text-green-500">方向</div>
                <div class="text-3xl font-bold val-up" id="last-dir">--</div>
            </div>
        </div>

        <!-- 5. Bottom: Table -->
        <div class="bb-box col-span-3 p-2 overflow-auto h-48 lg:h-auto">
            <div class="bb-header mb-2">交易流水 (最近10笔)</div>
            <table class="w-full text-xs text-left">
                <thead class="text-gray-500 border-b border-gray-800">
                    <tr>
                        <th class="p-1">时间</th>
                        <th class="p-1">方向</th>
                        <th class="p-1">入场</th>
                        <th class="p-1 text-right">盈亏</th>
                    </tr>
                </thead>
                <tbody class="text-gray-300" id="trade-list">
                    <!-- JS populated -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        async function updateData() {
            try {
                // Multi-path fetch strategy for GitHub Pages
                let res;
                const paths = [
                    'public/data.json',
                    '/kozbot/public/data.json', 
                    './public/data.json'
                ];
                
                for (const p of paths) {
                    try {
                        const r = await fetch(p + '?t=' + Date.now());
                        if (r.ok) { res = r; break; }
                    } catch(e){}
                }
                
                if (!res || !res.ok) throw new Error("无法读取 data.json");
                
                const data = await res.json();
                
                const setTxt = (id, val) => {
                    const el = document.getElementById(id);
                    if(el) el.innerText = val;
                };

                setTxt('net-pnl', data.stats.netPnL);
                setTxt('win-rate', data.stats.winRate);
                setTxt('pf', data.stats.profitFactor);
                setTxt('total-trades', data.stats.totalTrades);
                setTxt('last-update', data.updatedAt);
                
                // Update Table
                const tbody = document.getElementById('trade-list');
                tbody.innerHTML = data.recentTrades.map(t => {
                    const isWin = parseFloat(t.pnl) > 0;
                    const color = isWin ? 'val-up' : 'val-down';
                    return `<tr>
                        <td class="p-1">${t.shortTime}</td>
                        <td class="p-1 ${t.direction === 'UP' ? 'val-up' : 'val-down'}">${t.direction}</td>
                        <td class="p-1">$${t.price || t.entry_price}</td>
                        <td class="p-1 text-right ${color}">${(parseFloat(t.pnl)*100).toFixed(1)}%</td>
                    </tr>`;
                }).join('');
                
                // Update Direction
                if(data.recentTrades.length > 0) {
                    setTxt('last-dir', data.recentTrades[0].direction);
                }

                // Update Chart
                updateChart(data.chartData);
                
            } catch (e) {
                console.error("Data Load Error:", e);
                document.getElementById('last-update').innerText = "❌ " + e.message;
            }
        }

        let myChart;
        function updateChart(chartData) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const labels = chartData.map(d => d.time);
            const values = chartData.map(d => d.pnl);
            
            if (myChart) myChart.destroy();
            
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        borderColor: '#ff9900',
                        borderWidth: 2,
                        backgroundColor: 'rgba(255, 153, 0, 0.1)',
                        fill: true,
                        pointRadius: 0,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#222' }, ticks: { color: '#666' } },
                        y: { grid: { color: '#222' }, ticks: { color: '#666' } }
                    }
                }
            });
        }

        updateData();
        setInterval(updateData, 30000);
    </script>
</body>
</html>